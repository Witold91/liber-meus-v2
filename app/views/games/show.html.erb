<% content_for :title, t("app.titles.game", hero_name: @game.hero.name, app_name: t("app.name")) %>

<style>
  /* Lock the game page to the viewport — no page-level scroll */
  html, body { height: 100%; overflow: hidden; }
  .game-screen { height: calc(100dvh - 2rem); display: flex; flex-direction: column; overflow: hidden; }

  .game-over-banner { background: #1a1a0a; border: 1px solid #8a7a40; padding: 0.5rem 1rem; text-align: center; font-size: 0.85rem; color: #c8b860; flex-shrink: 0; }

  /* Grid fills whatever height remains after the banner */
  .game-layout { flex: 1; min-height: 0; display: grid; grid-template-columns: 1fr 320px; gap: 1rem; padding-top: 1rem; }
  @media (max-width: 768px) { .game-layout { grid-template-columns: 1fr; } }

  /* Console panel is a bounded flex column — only turn-log scrolls */
  .console-panel { display: flex; flex-direction: column; min-height: 0; height: 100%; overflow: hidden; border: 1px solid #333; background: #0a0a0a; }
  .console-header { flex-shrink: 0; padding: 0.75rem 1rem; border-bottom: 1px solid #333; background: #111; display: flex; justify-content: space-between; align-items: center; }
  .console-header h2 { font-size: 0.9rem; color: #8ab4a0; }
  .console-status { font-size: 0.8rem; color: #555; }
  .turn-log { flex: 1; min-height: 0; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
  .action-area { flex-shrink: 0; border-top: 1px solid #333; padding: 0.75rem; }
  .action-form { display: flex; gap: 0.5rem; }
  .action-input { flex: 1; background: #0d0d0d; color: #c8c8b4; border: 1px solid #555; padding: 0.5rem 0.75rem; font-family: inherit; font-size: 0.9rem; }
  .action-input:focus { outline: none; border-color: #8ab4a0; }
  .action-input:disabled { opacity: 0.5; }

  .right-panel { display: flex; flex-direction: column; gap: 0.5rem; min-height: 0; overflow-y: auto; }
  .hero-stat-bar { flex-shrink: 0; border: 1px solid #333; background: #111; padding: 0.75rem 1rem; font-size: 0.8rem; }
  .stat-row { display: flex; justify-content: space-between; padding: 0.2rem 0; }
  .stat-label { color: #666; }
  .stat-value { color: #c8c8b4; }
  .health-bar-outer { height: 4px; background: #333; margin-top: 0.5rem; }
  .health-bar-inner { height: 4px; background: #8ab4a0; transition: width 0.3s; }
  .momentum-track { display: flex; gap: 3px; margin-top: 0.35rem; }
  .momentum-pip { flex: 1; height: 6px; border-radius: 2px; opacity: 0.18; transition: opacity 0.3s, box-shadow 0.3s; }
  .momentum-pip.active { opacity: 1; box-shadow: 0 0 4px currentColor; }
  .momentum-value { font-variant-numeric: tabular-nums; min-width: 2.2ch; text-align: right; }

  /* Match in-panel scrollbars to the game page theme */
  .turn-log,
  .right-panel {
    scrollbar-width: thin;
    scrollbar-color: #3a3a3a #101010;
  }

  .turn-log::-webkit-scrollbar,
  .right-panel::-webkit-scrollbar {
    width: 10px;
  }

  .turn-log::-webkit-scrollbar-track,
  .right-panel::-webkit-scrollbar-track {
    background: #101010;
  }

  .turn-log::-webkit-scrollbar-thumb,
  .right-panel::-webkit-scrollbar-thumb {
    background: #3a3a3a;
    border: 1px solid #4a4a4a;
    border-radius: 8px;
  }

  .turn-log::-webkit-scrollbar-thumb:hover,
  .right-panel::-webkit-scrollbar-thumb:hover {
    background: #4a4a4a;
  }
</style>

<div class="game-screen" data-controller="game">
  <% if @game.status != "active" %>
    <div class="game-over-banner">
      <%= t("views.games.game_over", status: t("game.statuses.#{@game.status}")) %> <%= link_to t("views.games.start_new_game"), root_path %>
    </div>
  <% end %>

  <div class="game-layout">
    <%# Left: Console panel %>
    <div class="console-panel">
      <div class="console-header">
        <h2><%= @game.hero.name %> // <%= ScenarioCatalog.find(@game.scenario_slug, locale: @game.game_language)&.dig("title") %></h2>
        <span class="console-status" id="turn-counter"><%= t("views.games.turn", number: @game.turns.maximum(:turn_number) || 0) %></span>
      </div>

      <div class="turn-log" id="turn-log">
        <% @recent_turns.each do |turn| %>
          <%= render "games/turn", turn: turn %>
        <% end %>
      </div>

      <% if @game.status == "active" %>
        <div class="action-area">
          <%= form_with url: continue_game_path(@game), method: :post,
                data: { action: "submit->game#handleSubmit", turbo: false } do |f| %>
            <div class="action-form">
              <%= f.text_field :action_text,
                    placeholder: t("views.games.action_placeholder"),
                    class: "action-input",
                    autocomplete: "off",
                    data: { game_target: "input" } %>
              <%= f.submit "→", class: "btn", data: { game_target: "submit" } %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Right: Stage panel + hero stats %>
    <div class="right-panel">
      <%= render "games/hero_stats", game: @game %>

      <div id="stage-panel">
        <%= render "games/stage_panel", stage_context: @stage_context, game: @game %>
      </div>
    </div>
  </div>
</div>
