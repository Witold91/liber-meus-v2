<% content_for :title, t("app.titles.game", hero_name: @game.hero.name, app_name: t("app.name")) %>

<style>
  .game-layout { display: grid; grid-template-columns: 1fr 320px; gap: 1rem; height: calc(100vh - 120px); padding-top: 1rem; }
  @media (max-width: 768px) { .game-layout { grid-template-columns: 1fr; } }
  .console-panel { display: flex; flex-direction: column; border: 1px solid #333; background: #0a0a0a; }
  .console-header { padding: 0.75rem 1rem; border-bottom: 1px solid #333; background: #111; display: flex; justify-content: space-between; align-items: center; }
  .console-header h2 { font-size: 0.9rem; color: #8ab4a0; }
  .console-status { font-size: 0.8rem; color: #555; }
  .turn-log { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
  .action-area { border-top: 1px solid #333; padding: 0.75rem; }
  .action-form { display: flex; gap: 0.5rem; }
  .action-input { flex: 1; background: #0d0d0d; color: #c8c8b4; border: 1px solid #555; padding: 0.5rem 0.75rem; font-family: inherit; font-size: 0.9rem; }
  .action-input:focus { outline: none; border-color: #8ab4a0; }
  .action-input:disabled { opacity: 0.5; }
  .game-over-banner { background: #1a1a0a; border: 1px solid #8a7a40; padding: 0.5rem 1rem; text-align: center; font-size: 0.85rem; color: #c8b860; }
  .right-panel { display: flex; flex-direction: column; gap: 0.5rem; }
  .hero-stat-bar { border: 1px solid #333; background: #111; padding: 0.75rem 1rem; font-size: 0.8rem; }
  .stat-row { display: flex; justify-content: space-between; padding: 0.2rem 0; }
  .stat-label { color: #666; }
  .stat-value { color: #c8c8b4; }
  .health-bar-outer { height: 4px; background: #333; margin-top: 0.5rem; }
  .health-bar-inner { height: 4px; background: #8ab4a0; transition: width 0.3s; }
</style>

<div data-controller="game">
  <% if @game.status != "active" %>
    <div class="game-over-banner">
      <%= t("views.games.game_over", status: t("game.statuses.#{@game.status}")) %> <%= link_to t("views.games.start_new_game"), root_path %>
    </div>
  <% end %>

  <div class="game-layout">
    <%# Left: Console panel %>
    <div class="console-panel">
      <div class="console-header">
        <h2><%= @game.hero.name %> // <%= ScenarioCatalog.find(@game.scenario_slug, locale: @game.game_language)&.dig("title") %></h2>
        <span class="console-status"><%= t("views.games.turn", number: @game.turns.maximum(:turn_number) || 0) %></span>
      </div>

      <div class="turn-log" id="turn-log">
        <% @recent_turns.each do |turn| %>
          <%= render "games/turn", turn: turn %>
        <% end %>
      </div>

      <% if @game.status == "active" %>
        <div class="action-area">
          <%= form_with url: continue_game_path(@game), method: :post,
                data: { action: "submit->game#handleSubmit", turbo: false } do |f| %>
            <div class="action-form">
              <%= f.text_field :action_text,
                    placeholder: t("views.games.action_placeholder"),
                    class: "action-input",
                    autocomplete: "off",
                    data: { game_target: "input" } %>
              <%= f.submit "â†’", class: "btn", data: { game_target: "submit" } %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Right: Stage panel + hero stats %>
    <div class="right-panel">
      <div class="hero-stat-bar">
        <div class="stat-row"><span class="stat-label"><%= t("views.games.stats.health") %></span><span class="stat-value"><%= @game.world_state["health"] || 100 %>/100</span></div>
        <div class="health-bar-outer"><div class="health-bar-inner" style="width: <%= @game.world_state["health"] || 100 %>%"></div></div>
        <div class="stat-row" style="margin-top:0.4rem"><span class="stat-label"><%= t("views.games.stats.danger") %></span><span class="stat-value"><%= @game.world_state["danger_level"] || 0 %>%</span></div>
        <div class="stat-row"><span class="stat-label"><%= t("views.games.stats.momentum") %></span><span class="stat-value"><%= @game.world_state["momentum"] || 0 %></span></div>
      </div>

      <div id="stage-panel">
        <%= render "games/stage_panel", stage_context: @stage_context, game: @game %>
      </div>
    </div>
  </div>
</div>

<script>
  // Scroll turn log to bottom on load
  document.addEventListener("DOMContentLoaded", function() {
    var log = document.getElementById("turn-log");
    if (log) log.scrollTop = log.scrollHeight;
  });
</script>
