<% content_for :title, t("app.titles.game", hero_name: @game.hero.name, app_name: t("app.name")) %>

<% content_for :head do %>
  <style>
    :root {
      --theme-bg: <%= @theme["bg_color"] %>;
      --theme-text: <%= @theme["text_color"] %>;
      --theme-accent: <%= @theme["accent_color"] %>;
      --theme-font: <%= @theme["font_family"] %>;
      --theme-bg-image: <%= @theme["bg_image"].present? ? "url(/#{@theme["bg_image"]})" : "none" %>;
    }
  </style>
<% end %>

<style>
  /* Lock the game page to the viewport — no page-level scroll */
  html, body { height: 100%; overflow: hidden; }
  .game-screen { height: calc(100dvh - 2rem); display: flex; flex-direction: column; overflow: hidden; }

  .game-over-banner { background: #1a1208; border: 1px solid #8a7a40; padding: 0.5rem 1rem; text-align: center; font-size: 0.85rem; color: #c8b860; flex-shrink: 0; font-family: 'Lora', Georgia, serif; font-style: italic; }

  /* Grid fills whatever height remains after the banner */
  .game-layout { flex: 1; min-height: 0; display: grid; grid-template-columns: 1fr 320px; gap: 1rem; padding-top: 1rem; }
  @media (max-width: 768px) { .game-layout { grid-template-columns: 1fr; } }

  /* Console panel is a bounded flex column — only turn-log scrolls */
  .console-panel { display: flex; flex-direction: column; min-height: 0; height: 100%; overflow: hidden; border: 1px solid #2a2318; background: color-mix(in srgb, var(--theme-bg) 60%, transparent); }
  .console-header { flex-shrink: 0; padding: 0.75rem 1rem; border-bottom: 1px solid #2a2318; background: color-mix(in srgb, #0f0d09 85%, transparent); display: flex; justify-content: space-between; align-items: center; }
  .console-header h2 { font-family: 'Cinzel', 'Palatino Linotype', serif; font-size: 0.78rem; font-weight: 400; letter-spacing: 0.12em; color: var(--theme-accent); }
  .console-status { font-family: 'Lora', Georgia, serif; font-style: italic; font-size: 0.75rem; color: #4a4030; }
  .turn-log { flex: 1; min-height: 0; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }

  /* Action area — stage prompt feel */
  .action-area { flex-shrink: 0; border-top: 1px solid #2a2318; padding: 0.65rem 0.75rem; }
  .action-form { display: flex; align-items: center; gap: 0.5rem; }
  .action-prompt { font-family: 'Cinzel', serif; font-size: 0.7rem; color: var(--theme-accent); opacity: 0.6; flex-shrink: 0; user-select: none; }
  .action-input { flex: 1; background: transparent; color: var(--theme-text); border: none; border-bottom: 1px solid #3a3020; padding: 0.4rem 0.25rem; font-family: var(--theme-font); font-size: 1rem; }
  .action-input:focus { outline: none; border-bottom-color: var(--theme-accent); }
  .action-input:disabled { opacity: 0.4; }

  .right-panel { display: flex; flex-direction: column; gap: 0.5rem; min-height: 0; overflow-y: auto; }
  .hero-stat-bar { flex-shrink: 0; border: 1px solid #2a2318; background: #0f0d09; padding: 0.75rem 1rem; font-size: 0.8rem; }
  .stat-row { display: flex; justify-content: space-between; align-items: baseline; padding: 0.2rem 0; }
  .stat-label { font-family: 'Cinzel', serif; font-size: 0.58rem; letter-spacing: 0.18em; color: #4a4030; text-transform: uppercase; }
  .stat-value { color: #c8c0a8; font-variant-numeric: tabular-nums; }
  .health-bar-outer { height: 3px; background: #2a2318; margin-top: 0.5rem; }
  .health-bar-inner { height: 3px; background: var(--theme-accent); transition: width 0.3s; }
  .momentum-track { display: flex; gap: 3px; margin-top: 0.35rem; }
  .momentum-pip { flex: 1; height: 5px; border-radius: 1px; opacity: 0.15; transition: opacity 0.3s, box-shadow 0.3s; }
  .momentum-pip.active { opacity: 1; box-shadow: 0 0 4px currentColor; }
  .momentum-value { font-variant-numeric: tabular-nums; min-width: 2.2ch; text-align: right; }

  /* Scrollbars */
  .turn-log, .right-panel { scrollbar-width: thin; scrollbar-color: #2e2318 #0a0806; }
  .turn-log::-webkit-scrollbar, .right-panel::-webkit-scrollbar { width: 8px; }
  .turn-log::-webkit-scrollbar-track, .right-panel::-webkit-scrollbar-track { background: #0a0806; }
  .turn-log::-webkit-scrollbar-thumb, .right-panel::-webkit-scrollbar-thumb { background: #2e2318; border-radius: 4px; }
  .turn-log::-webkit-scrollbar-thumb:hover, .right-panel::-webkit-scrollbar-thumb:hover { background: #3e3020; }

  /* Mobile: world button + close bar hidden by default */
  .mobile-world-btn { display: none; }
  .mobile-panel-close { display: none; }

  @media (max-width: 768px) {
    /* Pin game-screen to viewport — prevents keyboard-induced scroll on iOS */
    body > .container { padding: 0; }
    .game-screen { position: fixed; inset: 0; height: 100%; }

    /* Right panel hidden, becomes a full-screen overlay when toggled */
    .right-panel {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 100;
      background: var(--theme-bg);
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
      overflow-y: auto;
    }
    .right-panel.mobile-open { display: flex; }

    /* Close bar at top of overlay */
    .mobile-panel-close {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #2a2318;
      margin-bottom: 0.25rem;
      flex-shrink: 0;
    }
    .mobile-panel-close-label {
      font-family: 'Cinzel', serif;
      font-size: 0.62rem;
      letter-spacing: 0.2em;
      color: #4a4030;
      text-transform: uppercase;
    }
    .mobile-panel-close-btn {
      background: transparent;
      border: 1px solid #2a2318;
      color: #4a4030;
      font-family: 'Cinzel', serif;
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      padding: 0.2rem 0.5rem;
      cursor: pointer;
    }

    /* World toggle button in console header */
    .mobile-world-btn {
      display: inline-block;
      background: transparent;
      border: 1px solid #2a2318;
      color: #4a4030;
      font-family: 'Cinzel', serif;
      font-size: 0.6rem;
      letter-spacing: 0.12em;
      padding: 0.2rem 0.55rem;
      cursor: pointer;
      flex-shrink: 0;
    }
    .mobile-world-btn:hover { color: var(--theme-accent); border-color: #3a3020; }

    /* On mobile, header has three items: title | turn | world-btn */
    .console-header { gap: 0.5rem; }
    .console-header h2 { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  }
</style>

<div class="game-screen" data-controller="game">
  <% if @game.status != "active" %>
    <div class="game-over-banner">
      <%= t("views.games.game_over", status: t("game.statuses.#{@game.status}")) %> <%= link_to t("views.games.start_new_game"), root_path %>
    </div>
  <% end %>

  <div class="game-layout">
    <%# Left: Console panel %>
    <div class="console-panel">
      <div class="console-header">
        <h2><%= @game.hero.name %> // <%= ScenarioCatalog.find(@game.scenario_slug, locale: @game.game_language)&.dig("title") %></h2>
        <span class="console-status" id="turn-counter"><%= t("views.games.turn", number: @game.turns.maximum(:turn_number) || 0) %></span>
        <button class="mobile-world-btn"
                data-game-target="worldBtn"
                data-action="click->game#toggleWorldInfo">World</button>
      </div>

      <div class="turn-log" id="turn-log">
        <% @recent_turns.each do |turn| %>
          <%= render "games/turn", turn: turn %>
        <% end %>
      </div>

      <% if @game.status == "active" %>
        <div class="action-area">
          <%= form_with url: continue_game_path(@game), method: :post,
                data: { action: "submit->game#handleSubmit", turbo: false } do |f| %>
            <div class="action-form">
              <span class="action-prompt">›</span>
              <%= f.text_field :action_text,
                    placeholder: t("views.games.action_placeholder"),
                    class: "action-input",
                    autocomplete: "off",
                    data: { game_target: "input" } %>
              <%= f.submit "→", class: "btn", data: { game_target: "submit" } %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Right: Scene panel + hero stats — becomes full-screen overlay on mobile %>
    <div class="right-panel" data-game-target="worldPanel">
      <div class="mobile-panel-close">
        <span class="mobile-panel-close-label">World Info</span>
        <button class="mobile-panel-close-btn"
                data-action="click->game#toggleWorldInfo">Close</button>
      </div>
      <%= render "games/hero_stats", game: @game %>
      <%= render "games/act_replay", acts_for_replay: @acts_for_replay, scenario: @scenario %>

      <div id="inventory-panel">
        <%= render "games/inventory", inventory: @scene_context&.dig(:inventory) || [] %>
      </div>

      <div id="scene-panel">
        <%= render "games/scene_panel", scene_context: @scene_context, game: @game %>
      </div>
    </div>
  </div>
</div>
